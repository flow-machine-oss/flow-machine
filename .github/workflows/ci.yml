name: CI/CD Pipeline

on:
  push:
    branches:
      - "**"
    tags:
      - "**"

env:
  BUN_VERSION: "1.3.5"

jobs:
  build_artifact:
    name: Build ${{ matrix.app }} artifact
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - app: web
            build_dir: .next
          - app: service
            build_dir: dist
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            app/${{ matrix.app }}/node_modules
          key: ${{ runner.os }}-bun-${{ matrix.app }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-${{ matrix.app }}-

      - name: Install dependencies
        run: bun install

      - name: Build ${{ matrix.app }}
        run: bun run build --filter ./app/${{ matrix.app }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-build
          path: app/${{ matrix.app }}/${{ matrix.build_dir }}
          include-hidden-files: true
          retention-days: 1

  build_image:
    name: Build ${{ matrix.app }} image
    runs-on: ubuntu-latest
    needs: build_artifact
    if: github.ref_type == 'tag' || github.ref == 'refs/heads/main'
    strategy:
      matrix:
        include:
          - app: web
            build_dir: .next
          - app: service
            build_dir: dist
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: extract-version
        uses: ./.github/actions/extract-version

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.app }}-build
          path: app/${{ matrix.app }}/${{ matrix.build_dir }}

      - name: Build Docker image
        run: |
          echo "REPO: ${{ env.AWS_ECR_REPOSITORY }}"
          docker build \
            -f docker/Dockerfile.app.${{ matrix.app }} \
            -t ${{ env.AWS_ECR_REPOSITORY }}/${{ matrix.app }}:${{ steps.extract-version.outputs.version }} \
            app/${{ matrix.app }}

      - name: Save Docker image
        run: |
          mkdir -p docker-images
          docker save ${{ env.AWS_ECR_REPOSITORY }}/${{ matrix.app }}:${{ steps.extract-version.outputs.version }} \
            -o docker-images/${{ matrix.app }}.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-docker-image
          path: docker-images/${{ matrix.app }}.tar
          retention-days: 1

  upload_image:
    name: Upload ${{ matrix.app }} image
    runs-on: ubuntu-latest
    needs: build_image
    if: github.ref_type == 'tag' || github.ref == 'refs/heads/main'
    strategy:
      matrix:
        app: [web, service]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: extract-version
        uses: ./.github/actions/extract-version

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.app }}-docker-image
          path: docker-images

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Load, tag, and push image to Amazon ECR
        env:
          AWS_ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker load -i docker-images/${{ matrix.app }}.tar
          docker tag \
            ${{ env.AWS_ECR_REPOSITORY }}/${{ matrix.app }}:${{ steps.extract-version.outputs.version }} \
            ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.AWS_ECR_REPOSITORY }}:${{ matrix.app }}.${{ steps.extract-version.outputs.version }}
          docker push ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.AWS_ECR_REPOSITORY }}:${{ matrix.app }}.${{ steps.extract-version.outputs.version }}
